<html>

    <?php

        $resource = htmlspecialchars($_SERVER["PHP_SELF"]);

        if (isset($_POST["username"]) && isset($_POST["password"])) {

            try {

                $conn = new PDO("pgsql:host=localhost;dbname=lubjanka", "postgres", "");
                // set the PDO error mode to exception
                $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
                
                $toPrint = "<head>
                    <title>Profile</title>
                </head>
                <body>
                <div style=\"display: flex; flex-direction:column; justify-content:center; align-items:center;\">
                    <h2>Available infos</h2>";

                $sql = "SELECT o.firstname, o.lastname, s.title FROM oligarchs o "
                    . "JOIN involvements i ON i.oligarch_username = o.username AND i.oligarch_password = o.password "
                    . "JOIN stuffs s ON s.title = i.stuff_id "
                    . "WHERE o.username = '" . $_POST["username"] . "' AND o.password = '" . $_POST["password"] . "' AND s.legality = TRUE";

                $result = $conn->query($sql);

                $first = true;

                while ($row = $result->fetch(\PDO::FETCH_ASSOC)) 

                    if ($first) {

                        $toPrint .= "<h3>Firstname</h3><p>" . $row["firstname"] . "</p><h3>Lastname</h3><p>" . $row["lastname"] . "</p><h3>Activities</h3><p>" . $row["title"] . "</p>";

                        $first = false;

                    }
                    
                    else

                        $toPrint .= "<p>" . $row["title"] . "</p>";
                
                if (substr_count($toPrint, "Firstname") == 0) 
    
                    $toPrint .= "<p>0 results</p><br>";

                $toPrint .= "<br><br><a href=\"" . $resource . "\">Reauthenticate</a></div></body>";

                echo $toPrint;
    
                $conn = null;
                
              } catch(PDOException $e) {

                echo "Connection failed: " . $e->getMessage();

              }

        }
        
        else 
            
            echo "<head>
                <title>Auth</title>
            </head>
            <body style=\"height:100vh; display:flex; justify-content:center; align-items:center;\">
                <fieldset>
                    <legend><h1>The Most Susceptible Russian Database</h1></legend>
                    <form action=\"" . $resource . "\" method=\"post\">
                        <label for=\"username\" style=\"display: block; text-align: center;\">Username</label>
                        <input type=\"text\" id=\"username\" name=\"username\" style=\"display: block; margin: auto;\"><br>
                        <label for=\"password\" style=\"display: block; text-align: center;\">Password</label>
                        <input type=\"text\" id=\"password\" name=\"password\" style=\"display: block; margin: auto;\"><br>
                        <input type=\"submit\" value=\"Login\" style=\"display: block; margin: auto;\">
                    </form>
                </fieldset>
            </body>";
       
    ?>

</html>